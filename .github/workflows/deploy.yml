
name: 🐳 Dynamic Docker Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: 🧭 Navigate to Devops directory
        run: |
          cd ~/Devops
          echo "📂 Current directory:"
          pwd
          echo "📁 Listing contents:"
          ls -R

      - name: 🧹 Clean up old containers
        run: |
          echo "🧹 Cleaning up existing containers..."
          docker ps -aq | xargs -r docker stop
          docker ps -aq | xargs -r docker rm

      - name: ⚙️ Build and deploy all Docker projects dynamically
        run: |
          set -e
          BASE_DIR=~/Devops
          PORT=3000

          echo "🔍 Scanning for Dockerfiles in $BASE_DIR..."
          mapfile -t DOCKERFILES < <(find $BASE_DIR -type f -name "Dockerfile")

          if [ ${#DOCKERFILES[@]} -eq 0 ]; then
            echo "❌ No Dockerfiles found in $BASE_DIR"
            exit 1
          fi

          for dockerfile in "${DOCKERFILES[@]}"; do
            PROJECT_DIR=$(dirname "$dockerfile")
            PROJECT_NAME=$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')

            echo "-------------------------------------------"
            echo "🚀 Found project: $PROJECT_NAME"
            echo "📦 Building image from: $PROJECT_DIR"
            echo "-------------------------------------------"

            cd "$PROJECT_DIR"
            docker build -t "${PROJECT_NAME}-app" .

            # Increment port dynamically
            PORT=$((PORT + 1))
            echo "🛳️ Running ${PROJECT_NAME}-app on port ${PORT}..."

            docker run -d --name "$PROJECT_NAME" -p ${PORT}:3000 "${PROJECT_NAME}-app" || {
              echo "⚠️ Failed to start container for $PROJECT_NAME"
              continue
            }

            cd "$BASE_DIR"
          done

          echo "✅ All Docker projects built and deployed successfully!"
