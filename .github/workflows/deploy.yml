name: Deploy on Self-Hosted Runner (Devops EC2)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Move project into ~/Devops
        run: |
          echo "ðŸ“¦ Syncing repo into ~/Devops folder..."
          rm -rf ~/Devops/ci-build || true
          mkdir -p ~/Devops/ci-build
          cp -r . ~/Devops/ci-build
          cd ~/Devops/ci-build
          echo "âœ… Repo copied into ~/Devops/ci-build"

      - name: Ensure Docker is installed
        run: |
          if ! command -v docker &> /dev/null; then
            echo "Installing Docker..."
            sudo apt update -y
            sudo apt install -y docker.io
            sudo systemctl enable docker
            sudo systemctl start docker
          fi
          docker --version

      - name: Deploy Containers
        run: |
          set -e
          cd ~/Devops/ci-build
          echo "ðŸ§¹ Cleaning up old containers..."
          docker stop backend frontend || true
          docker rm backend frontend || true

          # --- Microservices section ---
          if [ -d "Microservices/backend" ]; then
            echo "ðŸš€ Building Microservices backend..."
            cd Microservices/backend
            docker build -t backend-app .
            docker run -d --name backend -p 8080:8080 backend-app
            cd ../..
          fi

          if [ -d "Microservices/frontend" ]; then
            echo "ðŸŽ¨ Building Microservices frontend..."
            cd Microservices/frontend
            docker build -t frontend-app .
            docker run -d --name frontend -p 3000:3000 frontend-app
            cd ../..
          fi

          # --- Movies section (optional) ---
          if [ -d "Movies" ]; then
            echo "ðŸŽ¬ Found Movies project â€” building image..."
            cd Movies
            docker build -t movies-app .
            docker run -d --name movies -p 9090:9090 movies-app
            cd ..
          fi

          echo "âœ… Deployment finished successfully!"
