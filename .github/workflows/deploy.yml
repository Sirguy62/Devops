
name: ğŸ³ Dynamic Docker Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ğŸ§­ Navigate to Devops directory
        run: |
          cd ~/Devops
          echo "ğŸ“‚ Current directory:"
          pwd
          echo "ğŸ“ Listing contents:"
          ls -R

      - name: ğŸ§¹ Clean up old containers
        run: |
          echo "ğŸ§¹ Cleaning up existing containers..."
          docker ps -aq | xargs -r docker stop
          docker ps -aq | xargs -r docker rm

      - name: âš™ï¸ Build and deploy all Docker projects dynamically
        run: |
          set -e
          BASE_DIR=~/Devops
          PORT=3000

          echo "ğŸ” Scanning for Dockerfiles in $BASE_DIR..."
          mapfile -t DOCKERFILES < <(find $BASE_DIR -type f -name "Dockerfile")

          if [ ${#DOCKERFILES[@]} -eq 0 ]; then
            echo "âŒ No Dockerfiles found in $BASE_DIR"
            exit 1
          fi

          for dockerfile in "${DOCKERFILES[@]}"; do
            PROJECT_DIR=$(dirname "$dockerfile")
            PROJECT_NAME=$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')

            echo "-------------------------------------------"
            echo "ğŸš€ Found project: $PROJECT_NAME"
            echo "ğŸ“¦ Building image from: $PROJECT_DIR"
            echo "-------------------------------------------"

            cd "$PROJECT_DIR"
            docker build -t "${PROJECT_NAME}-app" .

            # Increment port dynamically
            PORT=$((PORT + 1))
            echo "ğŸ›³ï¸ Running ${PROJECT_NAME}-app on port ${PORT}..."

            docker run -d --name "$PROJECT_NAME" -p ${PORT}:3000 "${PROJECT_NAME}-app" || {
              echo "âš ï¸ Failed to start container for $PROJECT_NAME"
              continue
            }

            cd "$BASE_DIR"
          done

          echo "âœ… All Docker projects built and deployed successfully!"
